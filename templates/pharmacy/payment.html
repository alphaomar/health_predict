<!-- templates/pharmacy/payment.html -->
{% extends 'base/index.html' %}
{% block content %}
<h1>Payment</h1>
<h2>Order Total: ${{ order.total_amount }}</h2>

<div id="payment-options">
    <button id="stripe-option">Pay with Stripe</button>
    <button id="paypal-option">Pay with PayPal</button>
</div>

<div id="stripe-payment-form" style="display: none;">
    <div id="payment-element">
        <!-- Stripe.js will insert the payment element here -->
    </div>
    <button id="stripe-submit-button">Pay Now with Stripe</button>
    <div id="stripe-error-message"></div>
</div>

<div id="paypal-button-container" style="display: none;"></div>

<script src="https://js.stripe.com/v3/"></script>
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>
<script>
    // Stripe Integration
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();
    const paymentElement = elements.create('payment');
    
    document.getElementById('stripe-option').addEventListener('click', function() {
        document.getElementById('stripe-payment-form').style.display = 'block';
        document.getElementById('paypal-button-container').style.display = 'none';
        paymentElement.mount('#payment-element');
    });

    document.getElementById('stripe-submit-button').addEventListener('click', async (event) => {
        event.preventDefault();

        const {error} = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: "{% url 'payment_success' order.id %}",
            }
        });

        if (error) {
            const messageContainer = document.querySelector('#stripe-error-message');
            messageContainer.textContent = error.message;
        }
    });

    // PayPal Integration
    document.getElementById('paypal-option').addEventListener('click', function() {
        document.getElementById('paypal-button-container').style.display = 'block';
        document.getElementById('stripe-payment-form').style.display = 'none';
    });

    paypal.Buttons({
        createOrder: function(data, actions) {
            return fetch('/create-paypal-order/', {
                method: 'post',
                headers: {
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    order_id: '{{ order.id }}'
                })
            }).then(function(res) {
                return res.json();
            }).then(function(orderData) {
                return orderData.id;
            });
        },
        onApprove: function(data, actions) {
            return fetch('/capture-paypal-order/', {
                method: 'post',
                headers: {
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    paypalOrderId: data.orderID
                })
            }).then(function(res) {
                return res.json();
            }).then(function(orderData) {
                window.location.href = "{% url 'payment_success' order.id %}";
            });
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}